---
###############################################################################
# Heating Control System Configuration
###############################################################################
# Configuration for Python-based heating control with PID, window detection,
# and thermal performance monitoring
###############################################################################

# MQTT Topics
boiler_control_topic: "zigbe2mqtt/Boiler Heat Request Switch/set"
heartbeat_topic: "boiler_heat_request/heartbeat"
outside_temperature_topic: "zigbe2mqtt/Outdoor Sensor"

# Control Loop Settings
control_interval_seconds: 30  # How often to run control loop (30 sec)
heartbeat_interval_seconds: 300  # Heartbeat every 5 minutes (must be < Shelly auto-off of 10 min)

# Performance Reporting
report_interval_seconds: 3600  # Generate thermal performance report every hour

# Heating Zones Configuration
zones:
  ground_floor:
    # Temperature Sensor
    temperature_sensor_topic: "zigbee2mqtt/Living Room Sensor"

    # Pump Control
    pump_control_topic: "zigbee2mqtt/Pump UFH Ground Floor/set"

    # Setpoints
    default_setpoint: 20.0  # Default target temperature (°C)
    min_setpoint: 18.0      # Minimum allowed setpoint
    max_setpoint: 23.0      # Maximum allowed setpoint

    # PID Controller Tuning
    # kp: Proportional gain - how aggressively to respond to current error
    # ki: Integral gain - how much to account for accumulated error
    # kd: Derivative gain - how much to dampen based on rate of change
    pid_kp: 5.0   # Higher = more aggressive heating
    pid_ki: 0.1   # Higher = faster correction of steady-state error
    pid_kd: 1.0   # Higher = more damping of oscillations

    # Window Detection Settings
    window_detection_threshold_1min: 0.3  # °C/min rapid drop threshold
    window_detection_threshold_2min: 0.2  # °C/min sustained drop threshold
    history_length: 120  # Keep 10 minutes of temperature history (at 5sec intervals)

    # Pump Cycling Protection
    pump_min_on_minutes: 10      # Pump must stay ON for at least 10 minutes
    pump_min_off_minutes: 10     # Pump must stay OFF for at least 10 minutes
    pump_duty_on_threshold: 0.30 # Turn pump ON when PID duty exceeds 30%
    pump_duty_off_threshold: 0.05  # Turn pump OFF when PID duty drops below 5%

  first_floor:
    # Temperature Sensor
    temperature_sensor_topic: "zigbee2mqtt/First Floor Sensor"

    # Pump Control
    pump_control_topic: "zigbee2mqtt/Pump UFH First Floor/set"

    # Setpoints
    default_setpoint: 19.0  # Slightly cooler upstairs
    min_setpoint: 17.0
    max_setpoint: 22.0

    # PID Controller Tuning (same as ground floor)
    pid_kp: 5.0
    pid_ki: 0.1
    pid_kd: 1.0

    # Window Detection Settings
    window_detection_threshold_1min: 0.3
    window_detection_threshold_2min: 0.2
    history_length: 120

    # Pump Cycling Protection
    pump_min_on_minutes: 10
    pump_min_off_minutes: 10
    pump_duty_on_threshold: 0.30
    pump_duty_off_threshold: 0.05

###############################################################################
# PID Tuning Guidelines
###############################################################################
# Start with conservative values and tune based on system response:
#
# If temperature oscillates:
#   - Reduce kp (less aggressive)
#   - Increase kd (more damping)
#
# If temperature takes too long to reach setpoint:
#   - Increase kp (more aggressive)
#   - Increase ki (faster steady-state correction)
#
# If temperature overshoots setpoint:
#   - Reduce kp
#   - Increase kd
#
# If steady-state error persists (never quite reaches setpoint):
#   - Increase ki
#
# Recommended starting points for hydronic heating:
#   kp: 3.0 - 7.0
#   ki: 0.05 - 0.2
#   kd: 0.5 - 2.0
###############################################################################

###############################################################################
# Window Detection Guidelines
###############################################################################
# Temperature drop thresholds:
#   0.2°C/min = Slow drop (possible draft, not necessarily window)
#   0.3°C/min = Moderate drop (likely window opening)
#   0.5°C/min = Fast drop (definitely window opening)
#
# Adjust based on your room characteristics:
#   - Large rooms with high ceilings: Higher threshold (0.4-0.5°C/min)
#   - Small well-insulated rooms: Lower threshold (0.2-0.3°C/min)
#   - Drafty rooms: Higher threshold to avoid false positives
###############################################################################

###############################################################################
# Thermal Performance Monitoring
###############################################################################
# The system automatically tracks:
#
# 1. Heat Loss Rate (°C/hour when heating is OFF):
#    - How quickly the room cools down
#    - Lower is better (better insulation)
#    - Typical values:
#      * Excellent: < 0.3°C/h
#      * Good: 0.3 - 0.5°C/h
#      * Fair: 0.5 - 0.8°C/h
#      * Poor: > 0.8°C/h
#
# 2. Heat Gain Rate (°C/hour when heating is ON):
#    - How quickly the room warms up
#    - Indicates heating system power/efficiency
#    - Higher is better (assuming you don't overshoot)
#
# 3. Heat Loss per °C Delta (°C/h per °C difference with outside):
#    - How insulation performs relative to outdoor temperature
#    - Lower is better
#    - Example: 0.05 means you lose 0.5°C/h when it's 10°C colder outside
#
# Reports are generated every hour and published to MQTT:
#   Topic: heating/ground_floor/performance
#   Topic: heating/first_floor/performance
#
# View in logs:
#   journalctl -u automation-heating.service | grep "Thermal Performance"
###############################################################################

###############################################################################
# Pump Cycling Protection
###############################################################################
# Prevents premature pump wear from excessive on/off cycling.
#
# Without protection, worst case:
#   - PID oscillates near setpoint
#   - Pump cycles every 30 seconds (control loop interval)
#   - 120 cycles/hour = 2,880 cycles/day
#   - Pump failure in days!
#
# With protection (10 min minimum ON/OFF):
#   - Maximum ~6 cycles/hour
#   - Typical 1-3 cycles/hour
#   - ~50-200 cycles/day
#   - Normal pump lifespan (years)
#
# Parameters:
#
# 1. pump_min_on_minutes (default: 10)
#    - How long pump must stay ON before turning OFF
#    - Prevents rapid ON→OFF→ON cycling
#    - Increase if still seeing too many short cycles
#
# 2. pump_min_off_minutes (default: 10)
#    - How long pump must stay OFF before turning ON
#    - Prevents rapid OFF→ON→OFF cycling
#    - Can be shorter than min_on if needed
#
# 3. pump_duty_on_threshold (default: 0.30 = 30%)
#    - PID duty cycle required to turn pump ON
#    - Higher = less cycling, but slower response
#    - Lower = more responsive, but more cycling
#
# 4. pump_duty_off_threshold (default: 0.05 = 5%)
#    - PID duty cycle where pump turns OFF
#    - Lower = keeps pump on longer
#    - Higher = turns off sooner
#
# Deadband: The gap between ON (30%) and OFF (5%) prevents rapid oscillation
#   - Wider gap = less cycling
#   - Narrower gap = more precise but more cycling
#
# Manual Override:
#   - Manual setpoint changes bypass protection
#   - Allows immediate response to user commands
#   - Protection re-enables on next automatic cycle
#
# Monitoring:
#   - Cycle count logged every hour
#   - Warning if >6 cycles/hour
#   - Each cycle logged: "Pump cycle #N (ON)"
#
# Example logs:
#   INFO - ground_floor: Pump cycle #3 (ON)
#   INFO - ground_floor: Pump OFF (runtime: 12.3 min)
#   INFO - ground_floor: Pump cycles last hour: 4 (4.0/h)
#   WARNING - ground_floor: High pump cycle rate: 8.5 cycles/hour!
###############################################################################
